<!DOCTYPE html>
<html>
<head>
    <title>Gayatri School Fee System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

    <style>
        body{font-family:Poppins;background:#f4f6f9;margin:0}
        nav{background:#2c3e50;color:white;padding:15px;display:flex;gap:20px}
        nav button{background:none;border:none;color:white;font-size:16px;cursor:pointer}

        section{display:none;padding:30px}
        .active{display:block}

        .center-container{
        display:flex;
        flex-direction:column;
        align-items:center;
        width:100%;
        }

        .form-card{
        background:white;
        padding:20px;
        width:350px;
        border-radius:12px;
        box-shadow:0 4px 10px rgba(0,0,0,0.1)
        }

        input{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:6px}

        .save-btn{
        background:#27ae60;color:white;border:none;padding:10px;
        width:100%;border-radius:6px;cursor:pointer
        }

        .students-grid{
        display:grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap:20px;
        margin-top:30px;
        width:100%;
        }

        .student-card{
        background:white;padding:15px;border-radius:10px;
        box-shadow:0 4px 10px rgba(0,0,0,0.1);
        animation:fade 0.4s
        }

        .student-card h3{margin:0;color:#2c3e50}

        .delete-btn{
        background:#e74c3c;color:white;border:none;
        padding:6px 10px;border-radius:5px;cursor:pointer
        }

        .edit-btn{
        background:#3498db;color:white;border:none;
        padding:6px 10px;border-radius:5px;cursor:pointer;margin-right:5px
        }

        .pay-card{
        background:white;padding:20px;width:350px;
        border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1)
        }

        .receipt-box{
        background:white;padding:20px;width:400px;
        border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.1)
        }

        .print-btn{
        background:#2c3e50;color:white;border:none;
        padding:10px;border-radius:6px;margin-top:10px
        }

        @keyframes fade{
        from{opacity:0;transform:translateY(10px)}
        to{opacity:1;transform:translateY(0)}
        }

        select{
        width:100%;
        padding:10px;
        margin:8px 0;
        border:1px solid #ccc;
        border-radius:6px
        }
    </style>
</head>

<body>

<nav>
    <button onclick="show('home')">HOME</button>
    <button onclick="show('admin')">ADMIN PANEL</button>
    <button onclick="show('pay')">PAYMENT</button>
    <button onclick="show('receipt')">RECEIPT</button>
</nav>

<!-- HOME -->
<section id="home" class="active">
    <div class="center-container">
        <h2>Shri Gayatri English Medium High School</h2>
        <p>Quality education from LKG to 10th</p>
        <p>‚Çπ 9876543210</p>
        <p>üìß gayatrischool@gmail.com</p>
    </div>
</section>

<!-- ADMIN -->
<section id="admin">
    <div class="center-container">
        <h2>Student Management</h2>

        <div class="form-card">
            <input id="sid" placeholder="Student ID">
            <input id="sname" placeholder="Student Name">
            <input id="pname" placeholder="Parent Name">
            <input id="mobile" placeholder="Mobile Number">

            <select id="className">
                <option value="">Select Class</option>
                <option>PKG</option>
                <option>LKG</option>
                <option>UKG</option>
                <option>1</option><option>2</option><option>3</option>
                <option>4</option><option>5</option><option>6</option>
                <option>7</option><option>8</option><option>9</option>
                <option>10</option>
            </select>

            <input id="fee" placeholder="Total Fee">
            <button class="save-btn" onclick="saveStudent()">Save / Update</button>

            <hr style="margin:15px 0">

            <input id="searchId" placeholder="Search Student by ID">
            <button onclick="searchById()">Search</button>
        </div>

        <select id="classFilter" onchange="filterByClass()" style="margin-top:20px">
            <option value="">All Classes</option>
            <option>PKG</option>
            <option>LKG</option>
            <option>UKG</option>
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
            <option>7</option><option>8</option><option>9</option>
            <option>10</option>
        </select>

        <div class="students-grid" id="students"></div>
    </div>
</section>

<!-- PAYMENT -->
<section id="pay">
    <div class="center-container">
        <h2>Make Payment</h2>

        <div class="pay-card">
            <input id="pid" placeholder="Student ID">
            <button onclick="fetchStudent()">Fetch Student</button>
            <div id="pdata"></div>
            <input id="amt" placeholder="Amount to Pay">
            <button class="save-btn" onclick="pay()">Pay</button>
            <button class="print-btn" onclick="printPayment()">Print Receipt</button>
        </div>

        <div id="paymentReceipt" class="receipt-box" style="display:none">
            <h2 style="text-align:center">Shri Gayatri English Medium High School</h2>
            <hr>
            <p><b>Student ID:</b> <span id="r_sid"></span></p>
            <p><b>Student Name:</b> <span id="r_name"></span></p>
            <p><b>Parent Name:</b> <span id="r_parent"></span></p>
            <p><b>Mobile:</b> <span id="r_mobile"></span></p>

            <hr>
            <p><b>Total Fee:</b> ‚Çπ<span id="r_total"></span></p>
            <p><b>Previous Balance:</b> ‚Çπ<span id="r_prev"></span></p>
            <p><b>Paid Now:</b> ‚Çπ<span id="r_paid"></span></p>
            <p><b>Remaining Balance:</b> ‚Çπ<span id="r_remain"></span></p>

            <hr>
            <p><b>Date:</b> <span id="r_date"></span></p>
            <p style="text-align:center;margin-top:20px">
                Thank you for your payment üôè
            </p>
        </div>
    </div>
</section>

<!-- RECEIPT -->
<section id="receipt">
    <div class="center-container">
        <h2>Official Fee Receipt</h2>

        <div class="receipt-box">
            <input id="rid" placeholder="Student ID">
            <button onclick="getReceipt()">Get Receipt</button>
            <div id="rdata"></div>
            <button class="print-btn" onclick="window.print()">Print</button>
        </div>
    </div>
</section>

<script>
    const api="http://localhost:8080/api/students";
    let currentStudent=null;
    let previousBalance=0;
    let paidAmount=0;
    let allStudents=[];

    function show(id){
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    if(id==="admin") loadStudents();
    }

    function saveStudent(){
    fetch(api,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
    studentId:sid.value,
    name:sname.value,
    parentName:pname.value,
    mobile:mobile.value,
    className:className.value,
    totalFee:fee.value,
    balanceFee:fee.value
    })
    }).then(()=>{clearForm();loadStudents();});
    }

    function loadStudents(){
    fetch(api).then(r=>r.json()).then(data=>{
    allStudents=data;
    renderStudents(data);
    });
    }

    function deleteStudent(studentId){
    if(!confirm("Are you sure you want to delete this student?")) return;

    fetch(api + "/" + studentId, {
        method: "DELETE"
    })
    .then(response => {
        if (!response.ok) {
            throw new Error("Delete failed");
        }
        return response.text();
    })
    .then(() => {
        alert("Student deleted successfully");
        loadStudents(); // refresh cards
    })
    .catch(err => {
        console.error(err);
        alert("Delete failed. Please check backend.");
    });
}


    function renderStudents(list){
    students.innerHTML="";
    list.forEach(s=>{
    students.innerHTML+=`
    <div class="student-card">
    <h3>${s.name}</h3>
    <p>ID: ${s.studentId}</p>
    <p>Class: <b>${s.className}</b></p>
    <p>Parent: ${s.parentName}</p>
    <p>Mobile: ${s.mobile}</p>
    <p>Total Fee: ‚Çπ${s.totalFee}</p>
    <p><b>Balance: ‚Çπ${s.balanceFee}</b></p>
    <button class="edit-btn" onclick='editStudent(${JSON.stringify(s)})'>Edit</button>
    <button class="delete-btn" onclick='deleteStudent(${s.studentId})'>Delete</button>
    </div>`;
    });
    }

    function filterByClass(){
    let cls=classFilter.value;
    if(cls===""){
    renderStudents(allStudents);
    }else{
    let filtered=allStudents.filter(s=>s.className===cls);
    renderStudents(filtered);
    }
    }

    function searchById(){
    fetch(api+"/"+searchId.value).then(r=>r.json()).then(s=>{
    sid.value=s.studentId;
    sname.value=s.name;
    pname.value=s.parentName;
    mobile.value=s.mobile;
    className.value=s.className;
    fee.value=s.totalFee;
    });
    }

    function editStudent(s){
    sid.value=s.studentId;
    sname.value=s.name;
    pname.value=s.parentName;
    mobile.value=s.mobile;
    className.value=s.className;
    fee.value=s.totalFee;
    }

    function clearForm(){
    sid.value="";sname.value="";pname.value="";mobile.value="";
    className.value="";fee.value="";
    }

    /* PAYMENT */
    function fetchStudent(){
    fetch(api+"/"+pid.value).then(r=>r.json()).then(s=>{
    currentStudent=s;
    previousBalance=s.balanceFee;
    pdata.innerHTML=`
    <p><b>Name:</b> ${s.name}</p>
    <p><b>Parent:</b> ${s.parentName}</p>
    <p><b>Balance:</b> ‚Çπ${s.balanceFee}</p>`;
    });
    }

    function pay(){
    paidAmount = Number(amt.value);
    currentStudent.balanceFee -= paidAmount;

    fetch(api,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(currentStudent)
    });

    fetch("http://localhost:8080/api/payments",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
    studentId: currentStudent.studentId,
    amount: paidAmount,
    dateTime: new Date().toISOString()
    })
    }).then(()=>{
    alert("Payment Successful");
    generatePaymentReceipt();
    });
    }

    function generatePaymentReceipt(){
    document.getElementById("paymentReceipt").style.display="block";
    r_sid.innerText=currentStudent.studentId;
    r_name.innerText=currentStudent.name;
    r_parent.innerText=currentStudent.parentName;
    r_mobile.innerText=currentStudent.mobile;
    r_total.innerText=currentStudent.totalFee;
    r_prev.innerText=previousBalance;
    r_paid.innerText=paidAmount;
    r_remain.innerText=currentStudent.balanceFee;
    r_date.innerText=new Date().toLocaleString();
    }

    function printPayment(){
    let content=document.getElementById("paymentReceipt").innerHTML;
    let win=window.open("","","width=800,height=600");
    win.document.write(`
    <html>
    <head>
    <title>Receipt</title>
    <style>
    body{font-family:Poppins;padding:40px}
    .receipt-box{width:210mm;min-height:297mm;border:1px solid #000;padding:20mm}
    </style>
    </head>
    <body>
    <div class="receipt-box">${content}</div>
    </body>
    </html>
    `);
    win.document.close();
    win.print();
    }

    /* RECEIPT */
    function getReceipt(){
    let id = rid.value;

    fetch(api+"/"+id).then(r=>r.json()).then(s=>{
    fetch("http://localhost:8080/api/payments/student/"+id)
    .then(r=>r.json())
    .then(payments=>{

    let historyHtml = "";
    let totalPaid = 0;

    payments.forEach(p=>{
    totalPaid += p.amount;
    historyHtml += `
    <tr>
    <td>‚Çπ${p.amount}</td>
    <td>${new Date(p.dateTime).toLocaleString()}</td>
    </tr>`;
    });

    rdata.innerHTML = `
    <h3>Shri Gayatri English Medium High School</h3>
    <p><b>Student:</b> ${s.name}</p>
    <p><b>Parent:</b> ${s.parentName}</p>
    <p><b>Class:</b> ${s.className}</p>
    <p><b>Total Fee:</b> ‚Çπ${s.totalFee}</p>
    <p><b>Total Paid:</b> ‚Çπ${totalPaid}</p>
    <p><b>Remaining Balance:</b> ‚Çπ${s.balanceFee}</p>
    <p><b>Date:</b> ${new Date().toLocaleDateString()}</p>

    <h4>Payment History</h4>
    <table border="1" width="100%" style="border-collapse:collapse">
    <tr>
    <th>Amount</th>
    <th>Date & Time</th>
    </tr>
    ${historyHtml}
    </table>
    `;
    });
    });
    }
</script>

</body>
</html>
